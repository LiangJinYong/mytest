<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.inter.enterprise">

	<!-- Version Check -->
	<select id="getVersionCheckByOSType"  parameterType="string" resultType="hashmap">
		/* getVersionCheckCount */
		SELECT current_version_code AS currentVersionCode, current_version_name AS currentVersionName, is_forced_update AS isForceUpdate, date_format(UPDATE_DTTM, '%Y-%m-%d %H:%i:%s')  AS updateDttm 
		FROM app_enterprise_version 
		WHERE os_type = #{osType} AND version_key = (SELECT MAX(version_key) FROM app_enterprise_version WHERE os_type = #{osType})
	</select>
	
	<select id="getVersionCheckCountByVersionCode" parameterType="map" resultType="int">
		/* getVersionCheckCountByVersionCode */
		SELECT count(*) 
		FROM app_enterprise_version 
		WHERE is_forced_update = 1 AND current_version_code &gt; #{currentVersionCodeParam} AND current_version_code &lt;= #{currentVersionCodeDB}
	</select>
	
	<!-- Signup Superuser -->
	<insert id="insertAppEnterprise" parameterType="map">
		/* insertAppEnterprise */
		INSERT INTO app_enterprise
        (enterprise_key, name, registration_number, corporate_body_name, mobile_phone_number, address, website, mail, phone_number, type, reg_time)
        VALUES
        (null, #{name}, #{registrationNumber}, #{corporateBodyName}, #{mobilePhoneNumber}, #{address}, #{website}, #{mail}, #{phoneNumber}, #{type}, #{time})
        <selectKey resultType="int" keyProperty="enterpriseKey" order="AFTER">
        	SELECT LAST_INSERT_ID()
        </selectKey>
	</insert>
	
	<insert id="insertAppEnterpriseUser" parameterType="map">
		/* insertAppEnterpriseUser */
		INSERT INTO app_enterprise_user 
		(enterprise_user_key, enterprise_key, id, password, name, auth, reg_time) 
		VALUES 
		(null, #{enterpriseKey}, #{id}, #{password}, #{corporateBodyName}, 'AU00', #{time})
	</insert>
	
	<!-- Create User -->
	<select id="queryAppEnterpriseUserByToken" parameterType="map" resultType="hashmap">
		/* queryAppEnterpriseUserByToken */
		SELECT enterprise_user_key, enterprise_key, auth, password FROM app_enterprise_user WHERE token = #{token}
	</select>
	
	<insert id="insertNormalAppEnterpriseUser" parameterType="map">
		/* insertNormalAppEnterpriseUser */
		INSERT INTO app_enterprise_user 
		(enterprise_user_key, enterprise_key, id, password, name, auth, reg_time) 
		VALUES 
		(null, #{enterpriseKey}, #{id}, #{password}, #{name}, 'AU02', #{time})
	</insert>
	
	<!-- Login -->
	<select id="queryAppEnterpriseUserById" parameterType="map" resultType="hashmap">
		/* queryAppEnterpriseUserById */
		SELECT app_enterprise_user.id, app_enterprise_user.name, app_enterprise_user.auth, app_enterprise_user.password, app_enterprise.type 
		FROM app_enterprise_user LEFT JOIN app_enterprise 
		ON app_enterprise_user.enterprise_key = app_enterprise.enterprise_key 
		WHERE app_enterprise_user.id = #{id}
	</select>
	
	<update id="updateToken" parameterType="map">
		/* updateToken */
		UPDATE app_enterprise_user SET token = #{token} WHERE id = #{id}
	</update>
	
	<!-- User List -->
	<select id="queryUserList" parameterType="int" resultType="hashmap">
		/* queryUserList */
		SELECT enterprise_user_key AS enterpriseUserKey, id, name, auth 
		FROM app_enterprise_user 
		WHERE enterprise_key = #{enterpriseKey} AND auth IN ('AU02', 'AU03') ORDER BY auth ASC, name ASC
	</select>
	
	<!-- Modify User Info -->
	<select id="queryAppEnterpriseUserByEnterpriseUserKey" parameterType="int" resultType="hashmap">
		/* queryAppEnterpriseUserByEnterpriseUserKey */
		SELECT * FROM app_enterprise_user WHERE enterprise_user_key = #{enterpriseUserKey} AND (auth = 'AU02' OR auth = 'AU03')
	</select>
	
	<update id="updateUserInfo" parameterType="map">
		/* updateUserInfo */
		UPDATE app_enterprise_user SET password = #{password}, name = #{name} WHERE enterprise_user_key = #{enterpriseUserKey}
	</update>
	
	<!-- Modify My Info -->
	<update id="updateMyInfo" parameterType="map">
		/* updateMyInfo */
		UPDATE app_enterprise_user SET password = #{password}, name = #{name} WHERE token = #{token}
	</update>
	
	<!-- Activate User -->
	<update id="updateUserAuth" parameterType="map">
		/* updateUserAuth */
		UPDATE app_enterprise_user SET auth = 'AU02' WHERE enterprise_user_key = #{enterpriseUserKey}
	</update>
	
	<!-- Deactivate User -->
	<update id="updateUserAuthDeactivate" parameterType="map">
		/* updateUserAuthDeactivate */
		UPDATE app_enterprise_user SET auth = 'AU03' WHERE enterprise_user_key = #{enterpriseUserKey}
	</update>
	
	<!-- Send Mail Certification Code -->
	<select id="queryAppEnterpriseCount" parameterType="map" resultType="int">
		/* queryAppEnterpriseCount */
		SELECT count(*) FROM app_enterprise WHERE mail = #{mail}
	</select>
	
	<insert id="insertMailCertificationCode" parameterType="map">
		/* insertMailCertificationCode */
		INSERT INTO mail_certification_code (mail, certification_code, time) VALUES (#{mail}, #{certificationCode}, #{time})
        ON DUPLICATE KEY
        UPDATE certification_code = #{certificationCode}, time = #{time}, mail = #{mail}
	</insert>
	
	<!-- Confirm Mail Certification Code -->
	<select id="queryCertificationCode" parameterType="map" resultType="hashmap">
		/* queryCertificationCode */
		SELECT mail_certification_code.certification_code FROM mail_certification_code WHERE mail = #{mail}
	</select>
	
	<!-- Enterprise Physical Distribution -->
	<select id="querySequence" parameterType="string" resultType="hashmap">
		/* querySequence */
		SELECT re_seq.SEQUENCE FROM re_seq WHERE SEQUENCE = #{sequence}
	</select>
	
	<select id="queryAppPhysicalDistributionType" parameterType="string" resultType="hashmap">
		/* queryAppPhysicalDistributionType */
		SELECT app_physical_distribution.type
        FROM app_physical_distribution
        WHERE time = (SELECT MAX(time) FROM app_physical_distribution WHERE SEQUENCE = #{sequence})
        AND SEQUENCE = #{sequence}
	</select>
	
	<insert id="insertAppPhysicalDistribution" parameterType="map">
		/* insertAppPhysicalDistribution */
		INSERT INTO app_physical_distribution 
		(physical_distribution_key, SEQUENCE, latitude, longitude, type, time, enterprise_user_key, province, city, district, full_address) 
		VALUES 
		(null, #{sequence}, #{latitude}, #{longitude}, #{type}, #{time}, #{enterpriseUserKey}, #{province}, #{city}, #{district}, #{fullAddress})
	</insert>
	
	<!-- Enterprise Physical Distribution List -->
	<select id="queryPhysicalDistributionList" parameterType="map" resultType="hashmap">
		/* queryPhysicalDistributionList */
		SELECT app_physical_distribution.latitude, app_physical_distribution.longitude, app_enterprise.name AS enterpriseName, app_physical_distribution.time, app_enterprise_user.name AS enterpriseUserName, app_physical_distribution.type AS productDistributionType, province, city, district, full_address AS fullAddress
        FROM app_physical_distribution
        LEFT JOIN app_enterprise_user ON app_enterprise_user.enterprise_user_key = app_physical_distribution.enterprise_user_key
        LEFT JOIN app_enterprise ON app_enterprise_user.enterprise_key = app_enterprise.enterprise_key
        WHERE app_physical_distribution.SEQUENCE = #{sequence}
        ORDER BY app_physical_distribution.time DESC
	</select>
	
	<!-- Enterprise Physical Distribution Sequence List -->
	<select id="queryPhysicalDistributionSequenceList" parameterType="map" resultType="hashmap">
		/* queryPhysicalDistributionSequenceList */
		SELECT re_seq.SEQUENCE AS sequence, re_seq.SKU_CODE AS skuCode
		FROM app_physical_distribution
	    LEFT JOIN re_seq
        ON app_physical_distribution.SEQUENCE = re_seq.SEQUENCE
	    LEFT JOIN lian_order_info
        ON lian_order_info.ORDER_SEQ = re_seq.ORDERNUMBER
	    LEFT JOIN lian_user_info
        ON lian_user_info.USER_ID = lian_order_info.USER_ID
	    LEFT JOIN lian_biz_info
        ON lian_biz_info.BIZ_ID = lian_user_info.BIZ_ID
        <if test="auth == 'AU01'">
		    LEFT JOIN app_enterprise_user
	        ON app_enterprise_user.enterprise_user_key = app_physical_distribution.enterprise_user_key
			WHERE app_enterprise_user.enterprise_key = #{enterpriseKey}
        </if>
        <if test="auth == 'AU02'">
			WHERE app_physical_distribution.enterprise_user_key = #{enterpriseUserKey}
        </if>
	    AND lian_user_info.BIZ_ID = #{bizId}
	    AND lian_order_info.SVC_NM = #{svcNm}
	    <if test="sequence != ''">
	    	AND re_seq.SEQUENCE &lt; #{sequence}
	    </if>
		GROUP BY re_seq.SEQUENCE
		ORDER BY re_seq.SEQUENCE DESC
		LIMIT 20
	</select>
	
	<!-- Enterprise Physical Distribution Product List -->
	<select id="queryPhysicalDistributionProductList" parameterType="map" resultType="hashmap">
		/* queryPhysicalDistributionProductList */
		SELECT lian_order_info.SVC_NM AS svcNm
		FROM app_physical_distribution
	    LEFT JOIN re_seq
        ON app_physical_distribution.SEQUENCE = re_seq.SEQUENCE
	    LEFT JOIN lian_order_info
        ON lian_order_info.ORDER_SEQ = re_seq.ORDERNUMBER
	    LEFT JOIN lian_user_info
        ON lian_user_info.USER_ID = lian_order_info.USER_ID
	    LEFT JOIN lian_biz_info
        ON lian_biz_info.BIZ_ID = lian_user_info.BIZ_ID
        <if test="auth == 'AU01'">
		    LEFT JOIN app_enterprise_user
	        ON app_enterprise_user.enterprise_user_key = app_physical_distribution.enterprise_user_key
			WHERE app_enterprise_user.enterprise_key = #{enterpriseKey}
        </if>
        <if test="auth == 'AU02'">
        	WHERE app_physical_distribution.enterprise_user_key = #{enterpriseUserKey}
        </if>
	    AND lian_user_info.BIZ_ID = #{bizId}
	    <if test="svcNm != ''">
	    	AND lian_order_info.SVC_NM &gt; #{svcNm}
	    </if>
		GROUP BY lian_order_info.SVC_NM
		ORDER BY lian_order_info.SVC_NM ASC
		LIMIT 20
	</select>
	
	
	<!-- Enterprise Physical Distribution Enterprise List -->
	<select id="queryPhysicalDistributionEnterpriseList" parameterType="map" resultType="hashmap">
		/* queryPhysicalDistributionEnterpriseList */
		SELECT lian_biz_info.BIZ_ID AS bizId, lian_biz_info.BIZ_NAME AS bizName
		FROM app_physical_distribution
	    LEFT JOIN re_seq
        ON app_physical_distribution.SEQUENCE = re_seq.SEQUENCE
	    LEFT JOIN lian_order_info
        ON lian_order_info.ORDER_SEQ = re_seq.ORDERNUMBER
	    LEFT JOIN lian_user_info
        ON lian_user_info.USER_ID = lian_order_info.USER_ID
	    LEFT JOIN lian_biz_info
        ON lian_biz_info.BIZ_ID = lian_user_info.BIZ_ID
        <if test="auth == 'AU01'">
		    LEFT JOIN app_enterprise_user
	        ON app_enterprise_user.enterprise_user_key = app_physical_distribution.enterprise_user_key
			WHERE app_enterprise_user.enterprise_key = #{enterpriseKey}
        </if>
		<if test="auth == 'AU02'">
			WHERE app_physical_distribution.enterprise_user_key = #{enterpriseUserKey}
		</if>
		<if test="bizName != ''">
			AND lian_biz_info.BIZ_NAME &gt; #{bizName}
		</if>
		GROUP BY lian_biz_info.BIZ_ID
		ORDER BY lian_biz_info.BIZ_NAME ASC
		LIMIT 20
	</select>
</mapper>